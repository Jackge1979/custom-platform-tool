[[toc]]

# 自定义平台 3.0 - 前端架构设计

---

## 1. Changelog

| 作者 | 更新日期 | 版本 | 更改内容 |
|---|---|---|---|
| 相杰 | 2020-06-03 | v2.0.0 | 初稿 |
| 相杰 | 2020-06-04 | v2.1.0 | 根据评审进行调整，[更改日志](https://www.tapd.cn/41909965/documents/show/1141909965001000961) |
| 相杰 | 2020-06-05 | v2.1.1 | 调整 IUB-DSL 模型, 添加页面间的输入输出流向 |
| 相杰 | 2020-07-02 | v3.0.0 | 1. 添加编写目的和范围<br>2. 添加核心名词解释<br>3. 调整优化文档上下文内容<br>4. 添加系统设计思路<br>5. 添加核心模块引用<br>6. 优化分层架构图<br>7. 优化模块交互图 |
| 相杰 | 2020-07-08 | v3.1.0 | 1. 明确 IUB-DSL 的边界<br>2. 明确页面设计器的边界<br>3. 明确 node 服务的职责 |
| 相杰 | 2020-07-15 | v3.2.0 | 1. 明确 IUB-DSL 的基石是`“规则”`的设计思路<br>2. 明确`可视化作业规则` |

---

## 2. 前言

经过一段时间的思考，以及对系统需要提供的能力有进一步更清晰的认知，我们决定制定一份`渐进式`的架构设计。

其中，先从需求出发，建立一套支撑`可视化生产作业`的`规则`，围绕`规则`讨论如何 `产出` 和 `运行`，从而构建出一个可维护、可扩展、稳定的前端系统工程。

接着深入到各个系统模块之中，探寻其中的工作原理，模块 UML 关系等，实施系统构想。

与 2.0 相比，构思原理大致相同。不同的地方在于，我们制定了一套较为完善的`规则`，并且支持不断完善、扩展`规则`来支持更多的业务场景。从工程的角度来看，`规则`也是指导项目持续开发、维护、迭代的重要基石。

---

## 3. 编写目的和范围

- 深入浅出自定义工具 3.0 前端架构
  - 非技术可明白系统能力
  - 初级技术可明白运行原理
  - 中级技术可接入通用模块的设计、开发与维护
  - 高级技术可接入核心模块的设计、开发与维护
- 统一所有术语的概念
- 指导子模块、子应用、子系统的设计

---

## 4. 核心名词解释

### 4.1. 技术术语

- 模块（module）：一组能独立完成特定功能的`函数组合`（其中包括运行容器、函数、解析器、引擎等）。
- 解析（parse）：将`文件`或`其他输入`拆分为易于`存储或操纵`的数据。
- 解析器（parser）：接受一种`数据结构`，输出`另一种数据结构`的`函数或模块`。
- 数据转换器（data transformer）：一种转换特定数据类型的函数模块。
- 引擎（engine）：一种提供特定抽象能力、通过接口制定其中的内容表现行为，同时提供数据`解析和运行`的`模块或系统`。_例如游戏物理引擎，提供模拟物理世界的重力、碰撞等能力，开发游戏者只需按照规定的接口，便能开发出符合物理世界规律的游戏_。
  - 可视化编辑器引擎（VisualEditor engine）：通过抽象出提供`拖拽`、`实例化组件`、`编辑属性`等能力的引擎模块。
  - IUB-DSL 引擎：拥有`解析`、`执行`、`渲染` IUB-DSL 的能力的引擎模块。
  - 布局渲染引擎：提供布局渲染能力、UI 交互能力的引擎模块。
- 上下文（context）：模块在执行时产生的作用域环境，表现为`变量集合`、`作用域链`。
- 运行容器（container）：数据运算的容器，用于存放`运行时状态`、提供运行环境的`上下文`给子模块。
- 运行时状态（runtime state）：运行容器在运行过程中产生的`变量数据`。
- 运行时上下文（runtime context）：模块在运行时，外部提供的环境，以及提供给子模块的环境的`变量集合`。
- 静态数据（static data）：独立于系统存在的数据，也是系统最终产出的数据。
- 调度器（dispatcher）：根据需要处理的数据的类型，调用对应的`模块`进行处理的函数。
- 编译（compile）：将一种代码转成另一种在`代码运行器`中可运行的代码.
- 渲染器（renderer）：将数据`渲染到浏览器`的模块。
- 构造器（contractor）：用于`实例化类`的函数。
- 生成器（generator）：用于重载一个类生成另一种类的`工厂函数`。
- 过滤器（filter）：按照一定规则筛选输入数据的函数，`输入输出的数据类型一致`。

### 4.2. 其他术语

- 规则（rule）：行为约定，包括人员思维、行为的约定，系统的模块交互约定。
- 业务（business）：来自真实世界的、由人的需求驱动的`选择流程控制`。在代码上表示为根据实际需求的程序`执行流程控制`。

---

## 5. 设计原则

1. 第一原则 - 分拆业务 - 业务最小单元 - 找到业务最小单元线索 - 系统模块支持
2. 原子设计原则 - 系统架构原则，从最小单元考虑
3. SOLID - 系统架构原则
   1. 单一职责原则 - 指导 IUB-DSL 设计，功能、通用模块设计
   2. 开闭原则 - 保证增量模块对系统不具备破坏性
   3. 里氏替换原则 - OOP 的多态的概念，指导系统的插件体系
   4. 接口隔离原则 - 依赖接口编程
   5. 依赖倒置原则 - 指导模块设计

---

## 6. 设计思路

我们按照循序渐进的策略进行设计：`观察` -> `总结规律` -> `建立运行模型` -> `设计运行框架` -> `实施设计`。

于是我们采取 `业务` -> `建模` -> `架构` 的方法来指导前端架构的设计。调研实际业务场景、分析抽离业务，建立可以描述并运行业务的`规则`，并将`规则`命名为：`可视化作业规则`（以下简称`规则`），并且将该`规则`落地，成为 `IUB-DSL 模型`，并且围绕 `IUB-DSL 模型` 展开系统架构。

### 6.1. 可视化作业规则

无规则不成方圆。比如说人懂得建立和遵守规则，才有稳定的社会。所以我们也需要制定规则，保障整个系统的运行。其中的规则是包括人员、系统运行都需要遵守的。

在 `业务` -> `建模` -> `架构` 中间，我们还需要做很重要的工作：`建立规则`，即 `业务` -> (`拆解最小单元` -> `找出线索` -> `总结规律` -> `建立规则`) -> `建模` -> `架构`。

制定规则的过程中，始终保持一个基本原则：`第一原则 (first principle)`。将整个系统，或者说整个系统需求，分拆成最小的、不可再拆的`单元 (unit)`，再根据实际需求，找到其中的`线索（即相同点）`，将所有的`单元`按照`线索`，重新排列组合成系统。由于该系统的最小细节（最小单元）是靠规则保证运行的，所以系统也是可预测的、可持续维护的，人员的行为也将是可预测可掌控的。

### 6.2. 规则落地

规则也有`优劣`，能`落地`的规则才是`优`的规则。能落地是什么意思呢？其实就是指可以让程序和人都遵守。

`IUB-DSL` 便是`规则`的落地方案之一。关于 IUB-DSL ，在后续章节会深入介绍。

---

## 7. 业务领域模型

### 7.1. 概览

可视化生产工具是一种典型的`生产与消费`模式，我们将配置平台视为`生产者`，应用平台视为`消费者`，按照`可视化作业规则`，产出 `IUB-DSL` 静态数据：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594781170_9.png)

---

### 7.2. 详细

可视化编辑器产出的`页面布局信息`以及`所有的控件属性`，按照 `可视化作业规则` 转换成 `IUB-DSL` 数据，最终交给应用平台运行：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594781188_88.png)

名词解释：

- 控件属性：配置平台中的控件的属性，这些属性按照一定的规则和关系，分拆到不同的 IUB-DSL 节点中描述存储。

那么 `IUB-DSL` 具体的`运行规则`是什么呢？怎么能支持业务的运行呢？[查看 IUB-DSL 工作原理](https://www.tapd.cn/41909965/documents/show/1141909965001001060)深入了解一下。

---

## 8. 系统设计

有了业务处理模型，我们可以开始设计系统架构，来支持 `IUB-DSL 模型`的运行。

### 8.1. 前后端交互领域模型

我们将系统分为`「Web 客户端」`与`「服务端」`两大部分，并且采取了`前后端分离架构`。

于是我们建立了前后端交互领域模型：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593757486_71.png)

---

### 8.2. 前端模块交互设计

根据系统领域模型，我们细化了`「前端」`的设计，以及模块之间的交互关系：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593852806_80.png)

---

### 8.3. 系统架构设计思路

我们已经知道有哪些关键模块了，接下来需要设计一套可行稳定的系统框架来：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594285692_48.png)

`内核` -> `引擎` -> `业务插件` -> `子应用` -> `系统`。

核心思路是：核心能力由`引擎`提供，`业务`作为`插件`的形式插入到引擎运行，最终通过`内核`将多个引擎集合起来组成不同的`子应用`，最终成为可支持实际业务场景的`系统`。

---

### 8.4. 系统分层设计 - 详细

接下来，按照上述的设计思路，我们将模块按照实际的依赖关系，做了模块分层设计：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594210988_71.png)

---

## 9. 子模块或应用的方案设计集合

### 9.1. 核心模块

- [IUB-DSL 工作原理 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001060)
- [IUB-DSL 引擎 - 国才](https://www.tapd.cn/41909965/documents/show/1141909965001001077?file_type=word)
- [页面设计器 - 李佳](TODO)

### 9.2. 应用模块

- [权限控制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001065)
- [多页面路由机制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001066)
- [工程化 - 鹏辉](TODO)
- [数据转换器 - 鹏辉](TODO)
- [UI 组件接入标准 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001153)
- [Node 服务 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001064?file_type=word)
- [业务应用方案 - TODO](TODO)：
  - 权限管理
  - 菜单管理
  - ...

### 9.3. 引擎模块

- [可视化编辑器引擎 - TODO](TODO)
- [表达式引擎 - TODO](TODO)

### 9.4. 未定方案

- [定制接入方案 - TODO](TODO)

---

## 10. 最后

感谢大家的观看。
