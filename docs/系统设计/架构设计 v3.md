[[toc]]

# 自定义平台 3.0 - 前端架构设计

---

## 1. Changelog

| 作者 | 更新日期 | 版本 | 更改内容 |
|---|---|---|---|
| 相杰 | 2020-06-03 | v2.0.0 | 初稿 |
| 相杰 | 2020-06-04 | v2.1.0 | 根据评审进行调整，[更改日志](https://www.tapd.cn/41909965/documents/show/1141909965001000961) |
| 相杰 | 2020-06-05 | v2.1.1 | 调整 IUB-DSL 模型, 添加页面间的输入输出流向 |
| 相杰 | 2020-07-02 | v3.0.0 | 1. 添加编写目的和范围<br>2. 添加核心名词解释<br>3. 调整优化文档上下文内容<br>4. 添加系统设计思路<br>5. 添加核心模块引用<br>6. 优化分层架构图<br>7. 优化模块交互图 |
| 相杰 | 2020-07-08 | v3.1.0 | 1. 明确 IUB-DSL 的边界<br>2. 明确页面设计器的边界<br>3. 明确 node 服务的职责 |
| 相杰 | 2020-07-15 | v3.2.0 | 1. 明确 IUB-DSL 的基石是`“规则”`的设计思路<br>2. 明确`可视化作业规则` |
| 相杰 | 2020-07-23 | v3.3.0 | 1. 调整系统模块的关系<br>2. 明确 IUB-DSL 生成规则 |

---

## 2. 引言

### 2.1. 背景

经过一段时间的思考，以及对系统需要提供的能力有进一步更清晰的认知，我们制定一份`渐进式`的架构设计，来指导系统有计划的实施。

其中，先从需求出发，建立一套支撑`可视化生产作业`的`规则`，围绕`规则`讨论如何 `产出` 和 `运行`，从而构建出一个可维护、可扩展、稳定的前端系统工程。

接着深入到各个系统模块之中，探寻其中的工作原理，模块 UML 关系等，实施系统构想。

与 2.0 相比，构思原理大致相同。不同的地方在于，我们制定了一套较为完善的`规则`，并且支持不断完善、扩展`规则`来支持更多的业务场景。从工程的角度来看，`规则`也是指导项目持续开发、维护、迭代的重要基石。

### 2.2. 业务痛点

由于自定义平台 2.x 前端的开发规划不够细致，根基不稳，在后续的维护中扩展性较差，应对更多业务时显得有点力不从心。

| 自定义平台 2.x 前端问题 | 自定义平台 3.0 优化方案 |
|---|---|
| 模块划分不清晰，导致模块改动导致对系统的产生不可预测的影响 | 划清`核心模块`的`职责`与`输入输出` |
| 缺少确保模块改动不影响其他模块的机制（单元测试） | 将采用测试驱动开发 TDD 的方式保障核心模块稳定 |
| 重复渲染、无效渲染过多，导致渲染效率低下 | 围绕单向数据流思想设计，确保每次渲染的必要性 |
| 缺乏让规则落地的方案 | 将所有规则落地 |

### 2.3. 设计原则

1. 第一原则：指导业务拆解与系统设计
   1. 指导业务需求拆解
   2. 指导系统设计
2. 原子设计原则： 系统架构原则，从最小单元考虑
3. 单向数据流确保数据正确性
4. 解析引擎支撑系统核心
5. 领域模型指导功能模块设计
6. 单元测试先行：保障核心模块的稳定性
7. 规则必须有落地方案，否则不制定规则
8. SOLID

### 2.4. 设计类型说明

#### 2.4.1. 系统设计

1. 支持业务需求的系统所需要的技术模块
2. 技术模块的边界
3. 指导`方案设计`

#### 2.4.2. 方案设计

用于指导模块的`开发`与`详细设计`。

#### 2.4.3. 详细设计

用于说明模块的设计思路、开发过程。

---

## 3. 编写目的和范围

- 深入浅出自定义工具 3.0 前端架构
  - 非技术可明白系统能力
  - 初级技术可明白运行原理
  - 中级技术可接入通用模块的设计、开发与维护
  - 高级技术可接入核心模块的设计、开发与维护
- 统一所有术语的概念
- 指导子模块、子应用、子系统的设计

---

## 4. 术语

| 技术术语 | 含义 |
|---|---|
| 模块（module） | 一组能独立完成特定功能的`函数组合`（其中包括运行容器、函数、解析器、引擎等）。|
| 解析（parse） | 将`文件`或`其他输入`拆分为易于`存储或操纵`的数据。|
| 解析器（parser） | 接受一种`数据结构`，输出`另一种数据结构`的`函数或模块`。|
| 数据转换器（data transformer） | 一种转换特定数据类型的函数模块。|
| 引擎（engine） | 一种提供特定抽象能力、通过接口制定其中的内容表现行为，同时提供数据`解析和运行`的`模块或系统`。<br>_例如游戏物理引擎，提供模拟物理世界的重力、碰撞等能力，开发游戏者只需按照规定的接口，便能开发出符合物理世界规律的游戏_。|
| 可视化编辑器引擎（VisualEditor engine） | 通过抽象出提供`拖拽`、`实例化组件`、`编辑属性`等能力的引擎模块。|
| IUB-DSL 引擎 | 拥有`解析`、`执行`、`渲染` IUB-DSL 的能力的引擎模块。|
| 布局渲染引擎 | 提供布局渲染能力、UI 交互能力的引擎模块。|
| 上下文（context） | 模块在执行时产生的作用域环境，表现为`变量集合`、`作用域链`。|
| 容器（container） | 用于隔离模块运行环境，并提供存放`运行时状态`、`上下文`功能的模块。|
| 运行时状态（runtime state） | 运行容器在运行过程中产生的`变量数据`。|
| 运行时上下文（runtime context） | 模块在运行时，外部提供的环境，以及提供给子模块的环境的`变量集合`。|
| 静态数据（static data） | 独立于系统存在的数据，也是系统最终产出的数据。|
| 调度器（dispatcher） | 根据需要处理的数据的类型，调用对应的`模块`进行处理的函数。|
| 编译（compile） | 将一种代码转成另一种在`代码运行器`中可运行的代码.|
| 渲染器（renderer） | 将数据`渲染到浏览器`的模块。|
| 构造器（contractor） | 用于`实例化类`的函数。|
| 生成器（generator） | 用于重载一个类生成另一种类的`工厂函数`。|
| 过滤器（filter） | 按照一定规则筛选输入数据的函数，`输入输出的数据类型一致`。|

| 其他术语 | 含义 |
|---|---|
| 规则（rule） | 行为约定，包括人员思维、行为的约定，系统的模块交互约定。|
| 业务（business） | 来自真实世界的、由人的需求驱动的`选择流程控制`。<br>在代码上表示为根据实际需求的程序`执行流程控制`。 |

---

## 5. 设计思路

### 5.1. 第一原则

根据`第一原则`的指导，我们通过 `分析业务需求` -> `拆解最小业务单元` -> `找到线索` -> `总结规律` -> `建立模型` -> `设计系统` -> `实施工程` 的方式来指导业务拆解，在根据`原子设计原则`来指导前端架构的设计。

### 5.2. 原子设计原则

我们的世界由最小原子（目前是玻色子）按照一定的规律组成：`原子` -> `分子` -> `物质` -> `个体` -> `整体`。

在根据第一原则拆解`最小业务单元`后，找到其中的`规律`，并且制定一些规则，来保证`最小业务单元`在系统的能力范围之内稳定运行，以下便是规则的更详细叙述。

### 5.3. 规则

无规则不成方圆，而且规则需要落地才能保持，所以我们不仅仅是制定规则，而且通过`工具`来保证规则要被遵守。

| 规则 | 工具 | 自定义平台 2.x 是否支持 | 自定义平台 3.0 是否支持 |
|---|---|---|---|
| 开发人员接入规则 | Eslint<br>Typescript | ✖️ | ✔️ |
| 单元测试规则(80%覆盖率) | Jest<br>Cypress | ✖️ | ✔️ |
| 应用平台运行规则 | IUB-DSL | ✖️ | ✔️ |
| 模块边界 | 系统领域模型图 | ✖️ | ✔️ |

### 5.4. 知识落地

1. 通过文档将系统知识落地
2. 视频解说
   1. 当系统内核框架开发完成后，便进入接入新人开发业务的阶段。这个时候我们可以录制关于系统关键部分的视频解说，来指导新人的接入

---

## 6. 业务领域模型

### 6.1. 整体

可视化生产工具是一种典型的`生产与消费`模式，我们将配置平台视为`生产者`，应用平台视为`消费者`，按照`可视化作业规则`，产出 `IUB-DSL` 静态数据：

![图片描述](/tfl/pictures/202007/tapd_41909965_1595833797_52.png)

---

### 6.2. 配置平台

可视化编辑器产出的`页面布局信息`以及`所有的控件属性`，按照 `可视化作业规则` 转换成 `IUB-DSL` 数据，最终交给应用平台运行：

![图片描述](/tfl/pictures/202007/tapd_41909965_1594781188_88.png)

名词解释：

- 控件属性：配置平台中的控件的属性，这些属性按照一定的规则和关系，分拆到不同的 IUB-DSL 节点中描述存储。

那么 `IUB-DSL` 具体的`运行规则`是什么呢？怎么能支持业务的运行呢？[查看 IUB-DSL 工作原理](https://www.tapd.cn/41909965/documents/show/1141909965001001060)深入了解一下。

### 6.3. 应用平台

---

## 7. 系统领域模型

有了业务处理模型，我们可以开始设计系统架构，来支持 `IUB-DSL 模型`的运行。

### 7.1. 前后端交互模型

我们将系统分为`「Web 客户端」`与`「服务端」`两大部分，并且采取了`前后端分离架构`。

于是我们建立了前后端交互领域模型：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593757486_71.png)

---

### 7.2. 配置平台

根据系统领域模型，我们细化了`「前端」`的设计，以及模块之间的交互关系：

![图片描述](/tfl/pictures/202007/tapd_41909965_1593852806_80.png)

### 7.3. 应用平台

---

## 8. 系统分层设计

### 8.1. 系统架构设计思路

我们已经知道有哪些关键模块了，接下来需要设计一套可行稳定的系统框架来：

![图片描述](/tfl/pictures/202007/tapd_41909965_1595833883_59.png)

`内核` -> `引擎` -> `业务插件` -> `子应用` -> `系统`。

核心思路是：核心能力由`引擎`提供，`业务`作为`插件`的形式插入到引擎运行，最终通过`内核`将多个引擎集合起来组成不同的`子应用`，最终成为可支持实际业务场景的`系统`。

---

### 8.2. 基础建设

前端需要一定的基础建设，可以支持应用的快速开发。

![图片描述](/tfl/pictures/202007/tapd_41909965_1595833907_96.png)

### 8.3. 配置平台

接下来，按照上述的设计思路，我们将模块按照实际的依赖关系，做了模块分层设计：

![图片描述](/tfl/pictures/202007/tapd_41909965_1595833926_92.png)

### 8.4. 应用平台

![图片描述](/tfl/pictures/202007/tapd_41909965_1595833932_35.png)

---

## 9. 子模块或应用的方案设计集合

### 9.1. 核心模块

- [IUB-DSL 工作原理 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001060)
- [IUB-DSL 引擎 - 国才](https://www.tapd.cn/41909965/documents/show/1141909965001001077?file_type=word)
- [页面设计器 - 李佳](TODO)

### 9.2. 应用模块

- [权限控制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001065)
- [多页面路由机制方案 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001066)
- [工程化 - 鹏辉](TODO)
- [数据转换器 - 鹏辉](TODO)
- [UI 组件接入标准 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001153)
- [Node 服务 - 相杰](https://www.tapd.cn/41909965/documents/show/1141909965001001064?file_type=word)
- [业务应用方案 - TODO](TODO)：
  - 权限管理
  - 菜单管理
  - ...

### 9.3. 引擎模块

- [可视化编辑器引擎 - TODO](TODO)
- [表达式引擎 - TODO](TODO)

### 9.4. 未定方案

- [定制接入方案 - TODO](TODO)

---

## 10. 最后

感谢大家的观看。
